<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(#252222 20%, #000000 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background-color: #111320;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 50px rgba(233, 207, 88, 0.5); /* –°–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            width: 300px;
            opacity: 0; /* –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            transform: translateY(20px); /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ */
            animation: fadeIn 0.5s forwards; /* –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ */
        }
        @keyframes fadeIn {
            to {
                opacity: 1; /* –ö–æ–Ω–µ—á–Ω–∞—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
                transform: translateY(0); /* –í–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –ø–æ–ª–æ–∂–µ–Ω–∏—é */
            }
        }
        h2 {
            text-align: center;
            color: #e9cf58;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            color: white;
            padding: 10px;
            margin: 10px 0;
            border: 1px white #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #2c2f33;
        }
        input[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            box-sizing: border-box;
            margin-top: 50px;
        }
        input[type="submit"]:hover {
            background-color: #4cae4c;
        }
        .back-button {
            width: 100%;
            padding: 10px;
            background-color: #d9534f;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            box-sizing: border-box;
            margin-top: 10px;
        }
        .back-button:hover {
            background-color: #c9302c;
        }
        .error {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            color: #007bff;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
    <form id="resetPasswordForm" action="/reset_password" method="POST">

        <div class="password-container">
            <input type="password" name="new_password" id="new_password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('new_password', this)">üîí</button>
        </div>

        <div class="password-container">
            <input type="password" name="confirm_password" id="confirm_password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
            <input type="hidden" name="token" value="{{ token }}">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirm_password', this)">üîí</button>
        </div>

        <input type="submit" value="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
    </form>
    <button class="back-button" onclick="goBack()">–ù–∞–∑–∞–¥</button>
    <div class="error" id="password_error"></div>
</div>

<script>
    const form = document.getElementById('resetPasswordForm');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const token = document.querySelector('input[name="token"]').value;
        const errorDiv = document.getElementById('password_error');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if (!validatePassword(newPassword, confirmPassword)) {
            return; // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/reset_password/${token}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: newPassword })
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/login'; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
            } else {
                return response.json().then(data => { throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); });
            }
        })
        .catch(error => {
            errorDiv.textContent = error.message;
        });
    });


    function validatePassword(password, confirmPassword) {
        const errorDiv = document.getElementById('password_error');
        errorDiv.textContent = ''; // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

        const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[-@$!%*?&])[A-Za-z\d@$!%*?&-]{8,}$/;

        if (!passwordPattern.test(password)) {
            errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –±—É–∫–≤—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –Ω–∏–∂–Ω–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (-, @, $, !, %, *, ? –∏ &).';
            return false;
        }

        if (password !== confirmPassword) {
            errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.';
            return false;
        }

        return true;
    }

    function goBack() {
        window.location.href = '/login'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞
    }

    function togglePasswordVisibility(inputId, iconElement) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === "password";
        input.type = isPassword ? "text" : "password";
        iconElement.textContent = isPassword ? "üîì" : "üîí";
    }
</script>

</body>
</html>
